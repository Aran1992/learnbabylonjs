<html>
<head>
    <script src="protobuf.js"></script>
    <script src="pomelo-client.js"></script>
</head>
<body>
<script>
    var request = (method, url, data, callback) => {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            console.log("xmlhttp.readyState", url, xmlhttp.readyState);
            console.log("xmlhttp.status", url, xmlhttp.status);
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                console.log("xmlhttp.responseText", url, xmlhttp.responseText);
                var response = JSON.parse(xmlhttp.responseText);
                callback(response);
            }
        };
        xmlhttp.open(method, url, true);
        if (data) {
            xmlhttp.setRequestHeader("Content-Type", "application/json;charset=utf-8");
            xmlhttp.send(JSON.stringify(data));
        } else {
            xmlhttp.send();
        }
    };
    request("GET", "http://192.168.18.80:28302/products/dwc_29.json", undefined, function (response) {
        request(
            "POST",
            `http://${response.platSvrHost}:${response.platSvrPort}`,
            {
                head: {route: "http.ReqLogin", msgindex: 0, token: null},
                body: {plat: 2, username: new Date().getTime().toString(), password: '13456'},
            },
            function (response2) {
                pomelo.init({
                    host: response.gameSvrHost,
                    port: response.gameSvrPort,
                    user: {},
                    handshakeCallback: function (...args) {
                        console.log("pomelo.init handshakeCallback", ...args);
                    }
                }, function () {
                    pomelo.request("gate.gateHandler.queryEntry", {}, function (data) {
                        console.log("gate.gateHandler.queryEntry response", data);
                        pomelo.disconnect();
                        pomelo.init({
                            host: data.host,
                            port: data.port,
                            user: {},
                            handshakeCallback: function (...args) {
                                console.log("pomelo.init handshakeCallback 2", ...args);
                            }
                        }, function () {
                            pomelo.request("connector.entryHandler.login", {token: response2.body.token}, function (data) {
                                console.log("connector.entryHandler.login response", data);
                                pomelo.request("roomBamao.roomHandler.enterRoom", {
                                    gameId: 1,
                                    roomType: 1
                                }, function (data) {
                                    console.log("roomBamao.roomHandler.enterRoom", data);
                                    pomelo.request("roomBamao.roomHandler.ready", {}, function (data) {
                                        console.log("roomBamao.roomHandler.ready", data);
                                        pomelo.request("roomBamao.roomHandler.exitRoom", {}, function (data) {
                                            console.log("roomBamao.roomHandler.exitRoom", data);
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            }
        );
    });
</script>
</body>
</html>
